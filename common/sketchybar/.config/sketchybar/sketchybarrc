PLUGIN_DIR="$CONFIG_DIR/plugins"
source "$PLUGIN_DIR/accent_color.sh"

##### Bar Appearance #####
sketchybar --bar position=top height=28 color=0x00000000 topmost=on y_offset=30 margin=0 padding_right=10

##### Changing Defaults #####
default=(
  padding_left=2
  padding_right=2
  icon.font="Hack Nerd Font:Bold:14.0"
  label.font="Hack Nerd Font:Bold:12.0"
  icon.color=0xffffffff
  label.color=0xffffffff
)
sketchybar --default "${default[@]}"

##### AeroSpace Events #####
sketchybar --add event aerospace_workspace_change
sketchybar --add event aerospace_mode_change

##### Mode Indicator (always visible) #####
sketchybar --add item mode_indicator right \
           --subscribe mode_indicator aerospace_mode_change \
           --set mode_indicator \
           icon="ó°¹" \
           icon.font="Hack Nerd Font:Bold:12.0" \
           icon.color=0xffffffff \
           icon.padding_left=8 \
           icon.padding_right=4 \
           label="MAIN" \
           label.font="Hack Nerd Font:Bold:10.0" \
           label.color=0xffffffff \
           label.padding_left=0 \
           label.padding_right=8 \
           background.color=$ACCENT_COLOR \
           background.corner_radius=5 \
           background.height=24 \
           background.drawing=on \
           script="$PLUGIN_DIR/mode.sh"

##### Trigger for app updates #####
sketchybar --add item app_trigger right \
           --subscribe app_trigger aerospace_workspace_change front_app_switched \
           --set app_trigger \
           drawing=off \
           script="$PLUGIN_DIR/workspace_apps.sh"

##### AeroSpace Workspace Indicators #####
SPACE_ITEMS=()
for sid in $(aerospace list-workspaces --monitor all --empty no 2>/dev/null | sort -r || aerospace list-workspaces --all | sort -r); do
    SPACE_ITEMS+=("space.$sid")
    sketchybar --add item space.$sid right \
        --subscribe space.$sid aerospace_workspace_change \
        --set space.$sid \
        icon.drawing=off \
        label="$sid" \
        label.font="Hack Nerd Font:Bold:12.0" \
        label.color=0xffffffff \
        label.padding_left=10 \
        label.padding_right=10 \
        background.color=0x00000000 \
        background.corner_radius=5 \
        background.height=24 \
        background.drawing=off \
        click_script="aerospace workspace $sid" \
        script="$PLUGIN_DIR/aerospace.sh $sid"
done

##### Workspace Bracket (single black background with accent border) #####
if [ ${#SPACE_ITEMS[@]} -gt 0 ]; then
    sketchybar --add bracket workspaces "${SPACE_ITEMS[@]}" \
               --set workspaces \
               background.color=0xff1e1f29 \
               background.corner_radius=5 \
               background.height=24 \
               background.border_color=$ACCENT_COLOR \
               background.border_width=2 \
               background.drawing=on
fi

sketchybar --update
