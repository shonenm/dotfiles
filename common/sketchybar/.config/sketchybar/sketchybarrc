PLUGIN_DIR="$CONFIG_DIR/plugins"
source "$PLUGIN_DIR/colors.sh"

# Clear stale state files on startup
rm -f /tmp/sketchybar_workspaces_state /tmp/sketchybar_apps_state
echo "main" > /tmp/sketchybar_mode

##### Bar Appearance #####
sketchybar --bar position=bottom height=28 color=0x00000000 topmost=on y_offset=0 margin=0 padding_right=10

##### Changing Defaults #####
default=(
  padding_left=2
  padding_right=2
  icon.font="Hack Nerd Font:Bold:14.0"
  label.font="Hack Nerd Font:Bold:12.0"
  icon.color=0xffffffff
  label.color=0xffffffff
)
sketchybar --default "${default[@]}"

##### AeroSpace Events #####
sketchybar --add event aerospace_workspace_change
sketchybar --add event aerospace_mode_change

##### Claude Code Events #####
sketchybar --add event claude_status_change

##### Sleep Timer Events #####
sketchybar --add event sleep_timer_change

##### Mode Color Change Event #####
sketchybar --add event mode_color_changed

##### Mode Indicator (always visible) #####
sketchybar --add item mode_indicator left \
           --subscribe mode_indicator aerospace_mode_change \
           --set mode_indicator \
           icon="Û∞çπ" \
           icon.font="Hack Nerd Font:Bold:12.0" \
           icon.color=0xffffffff \
           icon.padding_left=8 \
           icon.padding_right=4 \
           label="MAIN" \
           label.font="Hack Nerd Font:Bold:10.0" \
           label.color=0xffffffff \
           label.padding_left=0 \
           label.padding_right=8 \
           background.color=$ACCENT_COLOR \
           background.corner_radius=5 \
           background.height=24 \
           background.drawing=on \
           script="$PLUGIN_DIR/mode.sh"

##### Sleep Timer (right side) #####
sketchybar --add item sleep_timer right \
           --subscribe sleep_timer sleep_timer_change mode_color_changed \
           --set sleep_timer \
           icon.drawing=off \
           label.font="Hack Nerd Font:Bold:10.0" \
           label.color=0xffffffff \
           label.padding_left=8 \
           label.padding_right=8 \
           background.color=0xff1e1f29 \
           background.border_color=$ACCENT_COLOR \
           background.border_width=2 \
           background.corner_radius=5 \
           background.height=24 \
           background.drawing=on \
           update_freq=60 \
           script="$PLUGIN_DIR/sleep_timer.sh"

##### Claude Code Badge Trigger (updates workspace badges) #####
sketchybar --add item claude_trigger right \
           --subscribe claude_trigger claude_status_change front_app_switched aerospace_workspace_change \
           --set claude_trigger \
           drawing=off \
           script="$PLUGIN_DIR/claude.sh"

##### Trigger for app updates #####
sketchybar --add item app_trigger right \
           --subscribe app_trigger aerospace_workspace_change front_app_switched mode_color_changed \
           --set app_trigger \
           drawing=off \
           script="$PLUGIN_DIR/workspace_apps.sh"

##### Trigger for workspace updates #####
sketchybar --add item workspace_trigger right \
           --subscribe workspace_trigger aerospace_workspace_change mode_color_changed \
           --set workspace_trigger \
           drawing=off \
           script="$PLUGIN_DIR/workspaces.sh"

##### Initial workspace setup #####
"$PLUGIN_DIR/workspaces.sh"

##### Day Progress (right side) #####
sketchybar --add item day_progress right \
           --subscribe day_progress mode_color_changed \
           --set day_progress \
           icon.drawing=off \
           label.font="Hack Nerd Font:Bold:10.0" \
           label.color=0xffffffff \
           label.padding_left=8 \
           label.padding_right=8 \
           background.color=0xff1e1f29 \
           background.border_color=$ACCENT_COLOR \
           background.border_width=2 \
           background.corner_radius=5 \
           background.height=24 \
           background.drawing=on \
           update_freq=60 \
           script="$PLUGIN_DIR/day_progress.sh"

##### Pomodoro Timer (right side) #####
sketchybar --add event pomodoro_update
sketchybar --add item pomodoro right \
           --subscribe pomodoro pomodoro_update mode_color_changed \
           --set pomodoro \
           icon.drawing=off \
           label.font="Hack Nerd Font:Bold:10.0" \
           label.color=0xff6c757d \
           label.padding_left=8 \
           label.padding_right=8 \
           background.color=0xff1e1f29 \
           background.border_color=$ACCENT_COLOR \
           background.border_width=2 \
           background.corner_radius=5 \
           background.height=24 \
           background.drawing=on \
           update_freq=5 \
           script="$PLUGIN_DIR/pomodoro.sh" \
           click_script="$HOME/dotfiles/scripts/pomodoro.sh toggle"

##### Layout Popup Anchor (invisible, center position) #####
sketchybar --add item layout_anchor center \
           --set layout_anchor \
           icon.drawing=off \
           label.drawing=off \
           background.drawing=off \
           width=0 \
           popup.horizontal=off \
           popup.align=center \
           popup.y_offset=-300 \
           popup.background.color=0xee1e1f29 \
           popup.background.corner_radius=12 \
           popup.background.border_color=$ACCENT_COLOR \
           popup.background.border_width=2 \
           popup.background.drawing=on

sketchybar --update
