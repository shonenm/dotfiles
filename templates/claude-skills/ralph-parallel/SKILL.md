---
name: ralph-parallel
description: 状態ファイルのタスクグラフから依存関係を分析し、ralph-worker で並列実行します。
user-invocable: true
disable-model-invocation: true
arguments: "<prd-file-or-task-list>"
---

# Ralph Parallel - 並列タスク実行オーケストレーター

状態ファイルのタスクグラフまたは PRD/タスクリストから依存関係を分析し、ralph-worker サブエージェントで並列実行します。同時実行ワーカー最大4。

## 引数

| 引数 | 説明 |
|------|------|
| `<prd-file-or-task-list>` | PRD ファイルのパス、カンマ区切りのタスクリスト、または省略 (状態ファイル使用) |

### 使用例

```
/ralph-parallel                                    # 状態ファイルの task_graph を使用
/ralph-parallel docs/prd.md                        # PRD ファイルからタスク分割
/ralph-parallel "Add login page, Add signup page"  # カンマ区切りタスクリスト
```

## 手順

### 1. タスクソースの決定

優先順位:
1. 引数なし + `/tmp/ralph_session_manifest` 存在: 状態ファイルの `task_graph` を使用
2. ファイルパス指定: ファイルを読み込みタスクを抽出
3. テキスト指定: カンマ区切りまたは改行区切りでタスクに分割

### 2. 依存関係の分析

- 各タスクの `deps` フィールドからDAG (有向非巡回グラフ) を構築
- 循環依存がないか検証
- ファイルの競合 (同じファイルを複数タスクが変更する可能性) を検出
- 依存関係が未解決のタスクは先行タスク完了まで待機

### 3. 並列実行

実行可能タスク (deps が全て完了済み) を最大4つまで同時に ralph-worker サブエージェントに委譲する。

各ワーカーに渡すプロンプト:
- タスクの説明と完了条件
- 対象ファイルのスコープ
- 既存コードベースのコンテキスト (状態ファイルの `context_report` から抽出)

Task ツールを使用して並列起動:
- 独立したタスクは同一メッセージ内の複数 Task ツールコールで起動
- 依存タスクは先行タスクの完了を待ってから起動

### 4. 進捗管理

- 各ワーカー完了時に状態ファイルの該当タスクを `"done"` に更新
- 新たに実行可能になったタスクを次のワーカーバッチに追加
- 全タスク完了まで繰り返す

### 5. 結果の統合

全ワーカー完了後:
1. 各ワーカーの結果を収集
2. 変更の競合がないか git で確認
3. 競合がある場合は手動マージが必要な旨を報告
4. 全体のサマリーをユーザーに報告

## 注意事項

- `isolation: worktree` により各ワーカーは独立した git worktree で作業する
- worktree はワーカー完了時に自動クリーンアップされる
- 同時実行ワーカー数の上限は4 (リソース制約)
- 競合が発生した場合は手動マージが必要になる可能性がある
